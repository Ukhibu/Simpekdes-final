rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================================================
    // FUNGSI BANTUAN (HELPER FUNCTIONS)
    // =================================================================

    // Cek apakah user sudah login
    function isAuthenticated() {
      return request.auth != null;
    }

    // Mengambil data profil user dari database
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Cek apakah data user ada di database
    function isUserExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Cek Role Admin Kecamatan
    function isAdminKecamatan() {
      return isAuthenticated() && 
             isUserExists() && 
             getUserData().role == 'admin_kecamatan';
    }

    // Cek Role Admin Desa
    function isAdminDesa() {
      return isAuthenticated() && 
             isUserExists() && 
             getUserData().role == 'admin_desa';
    }

    // Cek apakah Admin Desa memiliki hak atas desa data tersebut
    // Digunakan untuk CREATE (cek data yang dikirim)
    function isOwnerDesaCreate() {
      return isAdminDesa() && request.resource.data.desa == getUserData().desa;
    }

    // Digunakan untuk UPDATE/DELETE (cek data yang sudah ada)
    function isOwnerDesaResource() {
      return isAdminDesa() && resource.data.desa == getUserData().desa;
    }

    // Gabungan: Izin Write untuk Data Utama (Camat boleh semua, Admin Desa sesuai desanya)
    function canWriteMainData() {
      return isAdminKecamatan() || isOwnerDesaCreate();
    }
    
    function canModifyMainData() {
      return isAdminKecamatan() || isOwnerDesaResource();
    }

    // =================================================================
    // ATURAN KOLEKSI
    // =================================================================

    // 1. USERS (Profil Pengguna)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAdminKecamatan(); // Hanya camat buat akun
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdminKecamatan());
      allow delete: if isAdminKecamatan();
    }

    // 2. NOTIFIKASI
    match /notifications/{notificationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Sistem/User boleh kirim notif
      allow update: if isAuthenticated(); // Untuk 'mark as read'
      allow delete: if isAuthenticated(); // Hapus notif sendiri
    }

    // 3. PENGATURAN & BRANDING
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdminKecamatan();
    }
    match /branding/{brandId} {
      allow read: if true; // Public read agar logo muncul di halaman login
      allow write: if isAdminKecamatan();
    }

    // 4. DATA UTAMA (DESA)
    // Mengizinkan READ untuk semua authenticated user untuk menghindari error "Failed to load"
    // Membatasi WRITE hanya untuk yang berhak.

    // Pemerintahan
    match /perangkat/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }
    match /historyPerangkatDesa/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // System process
    }

    // Aset Desa
    match /aset/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }

    // Lembaga Desa (BPD, LPM, PKK, Karang Taruna, RT/RW)
    match /bpd/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }
    match /lpm/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }
    match /pkk/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }
    match /karang_taruna/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }
    match /rt_rw/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }

    // Program Kerja & Kegiatan (Naming Convention disamakan dengan kode JS)
    match /kegiatan/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }
    match /lpm_program/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }
    match /pkk_program/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }
    match /karang_taruna_program/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }
    // Alias jika kode menggunakan nama koleksi lama/berbeda
    match /karang_taruna_kegiatan/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }

    // E-File (SK Digital)
    match /efile/{docId} {
      allow read: if isAuthenticated();
      allow create: if canWriteMainData();
      allow update, delete: if canModifyMainData();
    }

    // System Utils
    match /system/{docId} {
      allow read, write: if isAuthenticated();
    }

    // 5. KEUANGAN DESA (Anggaran & Realisasi)
    match /anggaran_tahunan/{anggaranId} {
      allow read: if isAuthenticated();
      
      // Create: Hanya Admin Desa untuk desanya sendiri
      allow create: if isAdminDesa() && request.resource.data.desa == getUserData().desa;
      
      // Update/Delete: 
      // - Camat boleh akses penuh
      // - Admin Desa boleh edit jika status Draft/Ditolak ATAU jika field status tidak berubah (misal update data biasa)
      allow update: if isAdminKecamatan() || (isOwnerDesaResource());
      allow delete: if isAdminKecamatan() || (isOwnerDesaResource());

      // Sub-koleksi Realisasi
      match /realisasi/{realisasiId} {
        allow read: if isAuthenticated();
        allow create: if isAdminKecamatan() || (isAdminDesa() && request.resource.data.parentDesa == getUserData().desa);
        allow update, delete: if isAdminKecamatan() || (isAdminDesa() && resource.data.parentDesa == getUserData().desa);
      }
    }

    // Aturan Collection Group untuk Realisasi (Agar query "Lihat Semua Realisasi" tidak error permission)
    match /{path=**}/realisasi/{realisasiId} {
      allow read: if isAuthenticated();
    }

  }
}