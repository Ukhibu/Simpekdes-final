rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions (Fungsi Bantuan) ---
    function isUserAuthenticated() {
      return request.auth != null;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function getUserDesa() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.desa;
    }

    function isKecamatanAdmin() {
      return isUserAuthenticated() && getUserRole() == 'admin_kecamatan';
    }

    function isDesaAdmin() {
      return isUserAuthenticated() && getUserRole() == 'admin_desa';
    }

    // Fungsi untuk memeriksa apakah admin desa mengakses data desanya sendiri
    function isAccessingOwnDesa(desa) {
      return isDesaAdmin() && getUserDesa() == desa;
    }
    
    // Fungsi gabungan untuk aturan read/write umum
    function canAccessDesaData(desa) {
      return isKecamatanAdmin() || isAccessingOwnDesa(desa);
    }
    
    // --- Aturan untuk Koleksi Utama ---
    match /users/{userId} {
      allow read: if isUserAuthenticated() && (request.auth.uid == userId || isKecamatanAdmin());
      allow write: if isKecamatanAdmin();
    }
    
    match /settings/{docId} {
      allow read: if isUserAuthenticated();
      allow write: if isKecamatanAdmin();
    }
    
    match /notifications/{notificationId} {
      allow create: if isUserAuthenticated();
      allow read, update: if isUserAuthenticated() && request.auth.uid == resource.data.userId;
    }

    // --- Aturan untuk Modul Data ---
    match /perangkat/{docId} {
      allow read, write: if canAccessDesaData(resource.data.desa);
    }
    
    match /efile/{docId} {
      allow read, create, update: if canAccessDesaData(resource.data.desa);
      allow delete: if isKecamatanAdmin() || (isAccessingOwnDesa(resource.data.desa) && resource.data.status != 'terverifikasi');
    }
    
    match /keuangan/{docId} {
       allow read, write: if canAccessDesaData(resource.data.desa);
    }

    match /aset/{docId} {
       allow read, write: if canAccessDesaData(resource.data.desa);
    }

    // --- Aturan untuk Modul Organisasi Desa ---
    match /bpd/{docId} {
      allow read, write: if canAccessDesaData(resource.data.desa);
    }
    
    match /lpm/{docId} {
      allow read, write: if canAccessDesaData(resource.data.desa);
    }
    
    match /pkk/{docId} {
      allow read, write: if canAccessDesaData(resource.data.desa);
    }
    
    match /pkk_program/{docId} {
      allow read, write: if canAccessDesaData(resource.data.desa);
    }
    
    match /karang_taruna/{docId} {
      allow read, write: if canAccessDesaData(resource.data.desa);
    }
    
    match /karang_taruna_kegiatan/{docId} {
      allow read, write: if canAccessDesaData(resource.data.desa);
    }
    
    match /rt_rw/{docId} {
      allow read, write: if canAccessDesaData(resource.data.desa);
    }
  }
}

